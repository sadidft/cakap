import{db as e}from"./h3MKsja5.js";const d={async all(t=1){return e.kk.where("profile_id").equals(t).toArray()},async getById(t){return e.kk.get(t)},async getByNoKK(t){return e.kk.where("no_kk").equals(t).first()},async findByNIK(t){return t?e.kk.where("anggota_nik").equals(t).first():null},async add(t){t.created_at=t.created_at||new Date().toISOString(),t.updated_at=t.updated_at||null;const r=await e.kk.add(t);try{await e.kk_versions.add({kk_id:r,version_number:1,data:t,change_note:"Initial scan",created_at:new Date().toISOString()})}catch(a){console.warn("kk_versions add failed",a)}return r},async update(t,r){r.updated_at=new Date().toISOString();try{const a=await e.kk.get(t),n=(a.current_version||1)+1;await e.kk_versions.add({kk_id:t,version_number:n,data:{...a},change_note:r.change_note||"Update",created_at:new Date().toISOString()}),r.current_version=n}catch(a){console.warn("kk_versions update failed",a)}return e.kk.update(t,r)},async remove(t){const r=await e.kk.get(t);if(r)return await e.trash.add({profile_id:r.profile_id,type:"KK",original_id:t,data:r,deleted_at:new Date().toISOString(),expires_at:null}),e.kk.update(t,{is_deleted:!0,deleted_at:new Date().toISOString()})},async getVersions(t){return e.kk_versions.where("kk_id").equals(t).sortBy("version_number")},async applyVersion(t){const r=await e.kk_versions.get(t);if(!r)throw new Error("version not found");const a=r.data;await e.kk.put(a);const o=((await e.kk.get(a.id)).current_version||1)+1;return await e.kk_versions.add({kk_id:a.id,version_number:o,data:{...a},change_note:`Rollback to v${r.version_number}`,created_at:new Date().toISOString()}),await e.kk.update(a.id,{current_version:o,updated_at:new Date().toISOString()}),!0},async bulkUpdateCategory(t=[],r){if(!Array.isArray(t)||t.length===0)return 0;let a=0;for(const n of t)try{await e.kk.update(n,{kategori:r,updated_at:new Date().toISOString()}),a++}catch{}return a}};export{d as kkRepository};
